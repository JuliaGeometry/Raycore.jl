<!DOCTYPE html>
<html lang="en"><head><meta charset="UTF-8"/><meta name="viewport" content="width=device-width, initial-scale=1.0"/><title>BVH Hit Tests · Raycore</title><meta name="title" content="BVH Hit Tests · Raycore"/><meta property="og:title" content="BVH Hit Tests · Raycore"/><meta property="twitter:title" content="BVH Hit Tests · Raycore"/><meta name="description" content="Documentation for Raycore."/><meta property="og:description" content="Documentation for Raycore."/><meta property="twitter:description" content="Documentation for Raycore."/><script data-outdated-warner src="assets/warner.js"></script><link href="https://cdnjs.cloudflare.com/ajax/libs/lato-font/3.0.0/css/lato-font.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/juliamono/0.050/juliamono.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/fontawesome.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/solid.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.2/css/brands.min.css" rel="stylesheet" type="text/css"/><link href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.8/katex.min.css" rel="stylesheet" type="text/css"/><script>documenterBaseURL="."</script><script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js" data-main="assets/documenter.js"></script><script src="search_index.js"></script><script src="siteinfo.js"></script><script src="../versions.js"></script><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-mocha.css" data-theme-name="catppuccin-mocha"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-macchiato.css" data-theme-name="catppuccin-macchiato"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-frappe.css" data-theme-name="catppuccin-frappe"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/catppuccin-latte.css" data-theme-name="catppuccin-latte"/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-dark.css" data-theme-name="documenter-dark" data-theme-primary-dark/><link class="docs-theme-link" rel="stylesheet" type="text/css" href="assets/themes/documenter-light.css" data-theme-name="documenter-light" data-theme-primary/><script src="assets/themeswap.js"></script></head><body><div id="documenter"><nav class="docs-sidebar"><div class="docs-package-name"><span class="docs-autofit"><a href="index.html">Raycore</a></span></div><button class="docs-search-query input is-rounded is-small is-clickable my-2 mx-auto py-1 px-2" id="documenter-search-query">Search docs (Ctrl + /)</button><ul class="docs-menu"><li><a class="tocitem" href="index.html">Home</a></li><li><span class="tocitem">Tutorials</span><ul><li><a class="tocitem" href="raytracing_tutorial.html">Ray Tracing Tutorial</a></li><li class="is-active"><a class="tocitem" href="bvh_hit_tests.html">BVH Hit Tests</a><ul class="internal"><li><a class="tocitem" href="#Test-Setup"><span>Test Setup</span></a></li><li><a class="tocitem" href="#Test-1:-Single-Ray-Through-Center"><span>Test 1: Single Ray Through Center</span></a></li><li><a class="tocitem" href="#Visualization:-Single-Ray-with-Makie-Recipe"><span>Visualization: Single Ray with Makie Recipe</span></a></li><li><a class="tocitem" href="#Test-2:-Multiple-Rays-from-Different-Positions"><span>Test 2: Multiple Rays from Different Positions</span></a></li><li><a class="tocitem" href="#Visualization:-Multiple-Rays"><span>Visualization: Multiple Rays</span></a></li><li><a class="tocitem" href="#Test-4:-Difference-Between-any*hit-and-closest*hit"><span>Test 4: Difference Between any<em>hit and closest</em>hit</span></a></li><li><a class="tocitem" href="#Performance-Comparison"><span>Performance Comparison</span></a></li><li><a class="tocitem" href="#Summary"><span>Summary</span></a></li></ul></li></ul></li></ul><div class="docs-version-selector field has-addons"><div class="control"><span class="docs-label button is-static is-size-7">Version</span></div><div class="docs-selector control is-expanded"><div class="select is-fullwidth is-size-7"><select id="documenter-version-selector"></select></div></div></div></nav><div class="docs-main"><header class="docs-navbar"><a class="docs-sidebar-button docs-navbar-link fa-solid fa-bars is-hidden-desktop" id="documenter-sidebar-button" href="#"></a><nav class="breadcrumb"><ul class="is-hidden-mobile"><li><a class="is-disabled">Tutorials</a></li><li class="is-active"><a href="bvh_hit_tests.html">BVH Hit Tests</a></li></ul><ul class="is-hidden-tablet"><li class="is-active"><a href="bvh_hit_tests.html">BVH Hit Tests</a></li></ul></nav><div class="docs-right"><a class="docs-navbar-link" href="https://github.com/JuliaGeometry/Raycore.jl" title="View the repository on GitHub"><span class="docs-icon fa-brands"></span><span class="docs-label is-hidden-touch">GitHub</span></a><a class="docs-navbar-link" href="https://github.com/JuliaGeometry/Raycore.jl/blob/master/docs/src/bvh_hit_tests.md" title="Edit source on GitHub"><span class="docs-icon fa-solid"></span></a><a class="docs-settings-button docs-navbar-link fa-solid fa-gear" id="documenter-settings-button" href="#" title="Settings"></a><a class="docs-article-toggle-button fa-solid fa-chevron-up" id="documenter-article-toggle-button" href="javascript:;" title="Collapse all docstrings"></a></div></header><article class="content" id="documenter-page"><h1 id="BVH-Hit-Testing:-closest_hit-vs-any_hit"><a class="docs-heading-anchor" href="#BVH-Hit-Testing:-closest_hit-vs-any_hit">BVH Hit Testing: <code>closest_hit</code> vs <code>any_hit</code></a><a id="BVH-Hit-Testing:-closest_hit-vs-any_hit-1"></a><a class="docs-heading-anchor-permalink" href="#BVH-Hit-Testing:-closest_hit-vs-any_hit" title="Permalink"></a></h1><p>This document tests and visualizes the difference between <code>closest_hit</code> and <code>any_hit</code> functions in the BVH implementation using the new <code>RayIntersectionSession</code> API.</p><h2 id="Test-Setup"><a class="docs-heading-anchor" href="#Test-Setup">Test Setup</a><a id="Test-Setup-1"></a><a class="docs-heading-anchor-permalink" href="#Test-Setup" title="Permalink"></a></h2><pre><code class="language-julia hljs">using Raycore, GeometryBasics, LinearAlgebra
using WGLMakie
using Test
using Bonito

# Create a simple test scene with multiple overlapping primitives
function create_test_scene()
    # Three spheres at different distances along the Z-axis
    sphere1 = Tesselation(Sphere(Point3f(0, 0, 5), 1.0f0), 20)   # Furthest
    sphere2 = Tesselation(Sphere(Point3f(0, 0, 3), 1.0f0), 20)   # Middle
    sphere3 = Tesselation(Sphere(Point3f(0, 0, 1), 1.0f0), 20)   # Closest

    bvh = Raycore.BVHAccel([sphere1, sphere2, sphere3])
    return bvh
end

bvh = create_test_scene()

DOM.div(&quot;✓ Created BVH with $(length(bvh.primitives)) triangles from 3 spheres&quot;)</code></pre><h2 id="Test-1:-Single-Ray-Through-Center"><a class="docs-heading-anchor" href="#Test-1:-Single-Ray-Through-Center">Test 1: Single Ray Through Center</a><a id="Test-1:-Single-Ray-Through-Center-1"></a><a class="docs-heading-anchor-permalink" href="#Test-1:-Single-Ray-Through-Center" title="Permalink"></a></h2><p>Test a ray through the center that passes through all three spheres.</p><pre><code class="language-julia hljs"># Create a ray with slight offset to avoid hitting triangle vertices exactly
test_ray = Raycore.Ray(o=Point3f(0.1, 0.1, -5), d=Vec3f(0, 0, 1))

# Create session with closest_hit
session_closest = RayIntersectionSession(Raycore.closest_hit, [test_ray], bvh)

# Create session with any_hit for comparison
session_any = RayIntersectionSession(Raycore.any_hit, [test_ray], bvh)

fig = Figure()

# Left: closest_hit visualization
plot(fig[1, 1], session_closest)
plot(fig[1, 2], session_any)
Label(fig[0, 1], &quot;closest_hit&quot;, fontsize=20, font=:bold, tellwidth=false)
Label(fig[0, 2], &quot;any_hit&quot;, fontsize=20, font=:bold, tellwidth=false)

fig</code></pre><h2 id="Visualization:-Single-Ray-with-Makie-Recipe"><a class="docs-heading-anchor" href="#Visualization:-Single-Ray-with-Makie-Recipe">Visualization: Single Ray with Makie Recipe</a><a id="Visualization:-Single-Ray-with-Makie-Recipe-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization:-Single-Ray-with-Makie-Recipe" title="Permalink"></a></h2><pre><code class="language-julia hljs"># Create a ray with slight offset to avoid hitting triangle vertices exactly
test_ray = Raycore.Ray(o=Point3f(0.1, 0.1, 10), d=Vec3f(0, 0, -1))

# Create session with closest_hit
session_closest = RayIntersectionSession(Raycore.closest_hit, [test_ray], bvh)

# Create session with any_hit for comparison
session_any = RayIntersectionSession(Raycore.any_hit, [test_ray], bvh)

fig = Figure()
# Left: closest_hit visualization
plot(fig[1, 1], session_closest)
plot(fig[1, 2], session_any)
Label(fig[0, 1], &quot;closest_hit&quot;, tellwidth=false)
Label(fig[0, 2], &quot;any_hit&quot;, tellwidth=false)

fig</code></pre><h2 id="Test-2:-Multiple-Rays-from-Different-Positions"><a class="docs-heading-anchor" href="#Test-2:-Multiple-Rays-from-Different-Positions">Test 2: Multiple Rays from Different Positions</a><a id="Test-2:-Multiple-Rays-from-Different-Positions-1"></a><a class="docs-heading-anchor-permalink" href="#Test-2:-Multiple-Rays-from-Different-Positions" title="Permalink"></a></h2><p>Test multiple rays to ensure both functions work correctly.</p><pre><code class="language-julia hljs"># Test rays from different angles (with slight offset to avoid vertex hits)
test_positions = [
    Point3f(0.1, 0.1, -5),      # Center
    Point3f(0.5, 0.1, -5),      # Right offset
    Point3f(0.1, 0.5, -5),      # Top offset
    Point3f(-0.5, 0.1, -5),     # Left offset
]

# Create rays
rays = [Raycore.Ray(o=pos, d=Vec3f(0, 0, 1)) for pos in test_positions]

# Create session
session_multi = RayIntersectionSession(Raycore.closest_hit, rays, bvh)
fig2 = Figure()
ax = LScene(fig2[1, 1])

# Use different colors for each ray
ray_colors = [:purple, :orange, :cyan, :magenta]

plot!(ax, session_multi;
      show_bvh=true,
      bvh_alpha=0.3,
      ray_colors=ray_colors,
      hit_color=:green,
      show_hit_points=true,
      hit_markersize=0.15,
      show_labels=false)

fig2</code></pre><h2 id="Visualization:-Multiple-Rays"><a class="docs-heading-anchor" href="#Visualization:-Multiple-Rays">Visualization: Multiple Rays</a><a id="Visualization:-Multiple-Rays-1"></a><a class="docs-heading-anchor-permalink" href="#Visualization:-Multiple-Rays" title="Permalink"></a></h2><h2 id="Test-4:-Difference-Between-any*hit-and-closest*hit"><a class="docs-heading-anchor" href="#Test-4:-Difference-Between-any*hit-and-closest*hit">Test 4: Difference Between any<em>hit and closest</em>hit</a><a id="Test-4:-Difference-Between-any*hit-and-closest*hit-1"></a><a class="docs-heading-anchor-permalink" href="#Test-4:-Difference-Between-any*hit-and-closest*hit" title="Permalink"></a></h2><p>Demonstrate that <code>any_hit</code> can return different results than <code>closest_hit</code>.</p><pre><code class="language-julia hljs"># Create a complex scene with overlapping geometry
# This creates a BVH where traversal order can differ from distance order
using Random
Random.seed!(123)

complex_spheres = []

# Add some large overlapping spheres
push!(complex_spheres, Tesselation(Sphere(Point3f(0, 0, 10), 3.0f0), 20))
push!(complex_spheres, Tesselation(Sphere(Point3f(0.5, 0, 5), 0.5f0), 15))
push!(complex_spheres, Tesselation(Sphere(Point3f(-0.5, 0, 15), 1.5f0), 18))

# Add many small spheres to create complex BVH structure
for i in 1:30
    x = randn() * 5
    y = randn() * 5
    z = rand(8.0:0.5:12.0)
    r = 0.3 + rand() * 0.5
    push!(complex_spheres, Tesselation(Sphere(Point3f(x, y, z), r), 8))
end

complex_bvh = Raycore.BVHAccel(complex_spheres)

# Test rays to find cases where any_hit differs from closest_hit
test_rays = map(1:100) do i
    x = (i % 10) * 0.4 - 2.0
    y = div(i-1, 10) * 0.4 - 2.0
    Raycore.Ray(o=Point3f(x, y, -5), d=Vec3f(0, 0, 1))
end

session_closest = RayIntersectionSession(Raycore.closest_hit, test_rays, complex_bvh)
session_any = RayIntersectionSession(Raycore.any_hit, test_rays, complex_bvh)
fig = Figure()
# Left: closest_hit visualization
plot(fig[1, 1], session_closest)
plot(fig[1, 2], session_any)
Label(fig[0, 1], &quot;closest_hit&quot;, tellwidth=false)
Label(fig[0, 2], &quot;any_hit&quot;, tellwidth=false)

fig
</code></pre><p><strong>Key Findings:</strong></p><ul><li><code>any_hit</code> exits on the <strong>first</strong> intersection during BVH traversal (uses <code>intersect</code>, doesn&#39;t update ray)</li><li><code>closest_hit</code> continues searching and updates ray&#39;s <code>t_max</code> (uses <code>intersect_p!</code>)</li><li>In complex scenes with overlapping geometry, <code>any_hit</code> can return hits that are significantly farther</li><li>Both always agree on <strong>whether</strong> a hit occurred (hit vs miss)</li><li>The difference appears when BVH traversal order differs from spatial distance order</li></ul><h2 id="Performance-Comparison"><a class="docs-heading-anchor" href="#Performance-Comparison">Performance Comparison</a><a id="Performance-Comparison-1"></a><a class="docs-heading-anchor-permalink" href="#Performance-Comparison" title="Permalink"></a></h2><p>Compare the performance of <code>closest_hit</code> vs <code>any_hit</code>.</p><pre><code class="language-julia hljs">function render_io(obj)
    io = IOBuffer()
    show(io, MIME&quot;text/plain&quot;(), obj)
    printer = BonitoBook.HTMLPrinter(io; root_tag = &quot;span&quot;)
    str = sprint(io -&gt; show(io, MIME&quot;text/html&quot;(), printer))
    DOM.pre(HTML(str); style=&quot;font-size: 10px&quot;)
end</code></pre><pre><code class="language-julia hljs">using BenchmarkTools

test_ray = Raycore.Ray(o=Point3f(0.1, 0.1, -5), d=Vec3f(0, 0, 1))

# Benchmark closest_hit
closest_time = @benchmark Raycore.closest_hit($bvh, $test_ray)

# Benchmark any_hit
any_time = @benchmark Raycore.any_hit($bvh, $test_ray)


perf_table = map([
    (&quot;closest_hit&quot;, any_time),
    (&quot;any_hit&quot;, closest_time),
]) do (method, time_us)
    (Method = method, Time_μs = render_io(time_us))
end
Bonito.Table(perf_table)</code></pre><h2 id="Summary"><a class="docs-heading-anchor" href="#Summary">Summary</a><a id="Summary-1"></a><a class="docs-heading-anchor-permalink" href="#Summary" title="Permalink"></a></h2><p>This document demonstrated:</p><ol><li><p><strong><code>RayIntersectionSession</code></strong> - A convenient struct for managing ray tracing sessions</p><ul><li>Bundles rays, BVH, hit function, and results together</li><li>Provides helper functions: <code>hit_count()</code>, <code>miss_count()</code>, <code>hit_points()</code>, <code>hit_distances()</code></li></ul></li><li><p><strong>Makie visualization recipe</strong> - Automatic visualization via <code>plot(session)</code></p><ul><li>Automatically renders BVH geometry, rays, and hit points</li><li>Customizable colors, transparency, markers, and labels</li><li>Works with any Makie backend (GLMakie, WGLMakie, CairoMakie)</li></ul></li><li><p><strong><code>closest_hit</code></strong> correctly identifies the nearest intersection among multiple overlapping primitives</p><ul><li>Returns: <code>(hit_found::Bool, hit_primitive::Triangle, distance::Float32, barycentric_coords::Point3f)</code></li><li><code>distance</code> is the distance from ray origin to the hit point</li><li>Use <code>Raycore.sum_mul(bary_coords, primitive.vertices)</code> to convert to world-space hit point</li></ul></li><li><p><strong><code>any_hit</code></strong> efficiently determines if any intersection exists, exiting early</p><ul><li>Returns: Same format as <code>closest_hit</code>: <code>(hit_found::Bool, hit_primitive::Triangle, distance::Float32, barycentric_coords::Point3f)</code></li><li>Can exit early on first hit found, making it faster for occlusion testing</li></ul></li><li><p>Both functions handle miss cases correctly (returning <code>hit_found=false</code>)</p></li><li><p><code>any_hit</code> is typically faster than <code>closest_hit</code> due to early termination</p></li></ol><p>All tests passed! ✓</p></article><nav class="docs-footer"><a class="docs-footer-prevpage" href="raytracing_tutorial.html">« Ray Tracing Tutorial</a><div class="flexbox-break"></div><p class="footer-message">Powered by <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> and the <a href="https://julialang.org/">Julia Programming Language</a>.</p></nav></div><div class="modal" id="documenter-settings"><div class="modal-background"></div><div class="modal-card"><header class="modal-card-head"><p class="modal-card-title">Settings</p><button class="delete"></button></header><section class="modal-card-body"><p><label class="label">Theme</label><div class="select"><select id="documenter-themepicker"><option value="auto">Automatic (OS)</option><option value="documenter-light">documenter-light</option><option value="documenter-dark">documenter-dark</option><option value="catppuccin-latte">catppuccin-latte</option><option value="catppuccin-frappe">catppuccin-frappe</option><option value="catppuccin-macchiato">catppuccin-macchiato</option><option value="catppuccin-mocha">catppuccin-mocha</option></select></div></p><hr/><p>This document was generated with <a href="https://github.com/JuliaDocs/Documenter.jl">Documenter.jl</a> version 1.15.0 on <span class="colophon-date" title="Wednesday 29 October 2025 14:20">Wednesday 29 October 2025</span>. Using Julia version 1.12.1.</p></section><footer class="modal-card-foot"></footer></div></div></div></body></html>
